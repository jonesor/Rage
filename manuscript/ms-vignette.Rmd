---
title: "The functionality of RCompadre and Rage"
author: "Pol Capdevila and John Jackson"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(digits = 4)
options(width = 60)
```

## Introduction

The aim of this vignette is to give users a walk through of the functionality of the `Rcompadre` and `Rage` R packages.

The `Rcompadre` package allows users to access and manipulate data from the COMPADRE and COMADRE Plant and Animal Matrix Databases (Salguero-Gomez et al. 2015, 2016). These two databases contain matrix population models (MPMs) and associated metadata obtained from the published and "grey" literature.

The `Rage` package provides tools for conducting aging- and life history-focussed analysis of MPMs. `Rage` includes a wide variety of functions the calculation of life history traits (e.g. longevity, generation time), vital rates (e.g. growth, reproduction) and to run perturbation analyses (e.g. vital rate elasticities). Furthermore, the package includes functions to manipulate and transform MPMs and life tables.

## Research question (start of manuscript section)

In the following example we illustrate the use of `Rcompadre` to carry out typical data download and preparation tasks for an analysis relevant to comparative population dynamics research and implemented using `Rage`.

Let's imagine that we are interested in exploring variation in mammal longevity across different ecoregions. The demographic information contained in MPMs can be used to estimate longevity (see SI in Jones et al, 2014) and we can therefore leverage the large taxonomic and geographic coverage of COMADRE to make interesting comparative inferences. 

# [RCOMPADRE SECTION BEGINS]

The first task is to install the latest version of `Rcompadre.` `RCompadre` is developed on the github platform and can therefore be installed using `remotes::install_github` and loaded using `library` as follows:

```{r eval = FALSE,message=FALSE}
install.packages("remotes")
remotes::install_github("jonesor/Rcompadre")
```

After ensuring that the packages are installed we load them:

```{r, echo=TRUE,message=FALSE}
library(Rcompadre)
library(tidyverse)
```

After that, users can download the latest version of the COMPADRE or COMADRE databases from the website (or load from a local file) using the function `cdb_fetch`. Note that users can also load local files with the same function `x <- cdb_fetch("PATH/TO/FILE/COMADRE_v.4.21.1.0.RData")`. After loading the data, a message is displayed stating the database version number, date of release, and links to the user agreement and citation request.   

```{r fetch data with cdb_fetch}
comadre <- cdb_fetch("comadre")
```

### Data management

The COMADRE database includes metadata associated with each matrix including taxonomic information, geolocation, and details of the source publication. A full description of these variables can be found in the User Guide via the website [www.compadre-db.org](http://www.compadre-db.org). We can get an idea of the richness of this metadata simply by using the `names` command. 

```{r Names, eval = FALSE}
names(comadre)
```

The MPMs are contained in a list column called `mat` where each element contains a list of the four matrices, **A** and the submatrices **U**, **F** and **C** (see above). The list also includes information on matrix stage definitions. All other columns of the COMADRE database object are ordinary vectors. 

We can explore the taxonomic groups available in the dataset.

```{r taxonomic table}
table(comadre$Class)
```

We see that COMADRE contains information for many taxonomic groups. However, in this case we are only interested in mammals.`Rcompadre` allows us to subset the database easily using the function `filter` from `dplyr` as if our `CompadreDB` object was an ordinary data frame.

```{r subset mammals}
mammals <- comadre %>%
  filter(Class == "Mammalia")

table(mammals$Order)
```

### Data checking 

Although COMPADRE and COMADRE data undergo rigorous checks before being made available, that doesn't necessarily mean that all data will meet the exact requirements of any particular analysis. `Rcompadre` includes several functions for checking the data. 

For example, for a minority of studies, it is not possible decompose **A** matrices into the **U** **F** and **C** submatrices. This is potentially important because the calculation of some life history traits requires one or more of these submatrices. For instance, in our example analysis focussing on longevity we require a **U** submatrix with no missing values. 

To check, and filter out un-usable matrices, we use the function `cdb_flag` and, in this case, specify `checks = c("check_NA_U","check_zero_U")` (see `?cdb_flag` for all available data checks). This specifies that we want to check whether the studies contain **U** matrices (`check_NA_U`) and whether these **U** matrices are all zeros (`check_zero_U`). 

```{r Check matU}
mammals <- cdb_flag(mammals, checks = c("check_NA_U", "check_zero_U"))
```

The `cdb_flag` function will return a version of the data with additional logical columns for each of the checks, which we can summarise using `table`.

```{r Check matU2}
table(mammals$check_NA_U)
table(mammals$check_zero_U)
```

Now we can `filter` our data to include only data with suitable **U** matrices.

```{r subset matU}
mammals <- mammals %>%
  filter(check_NA_U == FALSE, check_zero_U == FALSE)
```

```{r, echo = FALSE}
mammals <- mammals %>%
  mutate(latLongPresent = (is.na(Lat) + is.na(Lon)) == 0)
```

Finally, most COM(P)ADRE data includes geolocation information. In addition to `Country` and `Continent`, precise latitude and longitude (`Lat` and `Lon`) make it easy to visualise the spatial extent of our data set using tools in the `ggplot2` and `maps` packages (Figure X). 


*Figure 2: The spatial extent of data in the subset of mammal data used in our example analysis. Note that `r table(mammals$latLongPresent)[1]` of matrices in our set (~`r round(100*(table(mammals$latLongPresent)[1]/nrow(mammals)))`%) do not have associated spatial information.*

```{r map of data, fig.width= 10, fig.height= 8, warning=FALSE}
globalDist <- ggplot(mammals, aes(x = Lon, y = Lat)) +
  borders(database = "world", fill = "grey80", col = NA) +
  geom_point(alpha = 0.9) +
  labs(x = NULL, y = NULL) +
  theme_minimal()
```


Now that we are sure that our data set contains the right information, we are ready to calculate longevity using `Rage`. 

# [RCOMPADRE SECTION ENDS]

# [RAGE SECTION BEGINS]

In the following section we illustrate the use of some of these functions, focussing on carrying out the longevity analysis introduced above. Our first task will be to install the package from Github.

```{r eval = FALSE}
install.packages("remotes")
remotes::install_github("jonesor/Rage")
```

Then load it.

```{r load Rage}
library(Rage)
```

Our goal is to calculate the longevity of mammals from across the world using the dataset we generated above. We can do this using the `longevity` function, which simulates the ages at death of a synthetic cohort of individuals following the demographic pattern described by the MPM. The function documentation  (`?longevity`) tells us that it requires the  **U** matrix, which we can obtain using the `matU` function from `Rcompadre`. 

The function also requires us to define which stage we consider to be the beginning of life. This is fairly clear for most mammals, but may be contentious in some groups, such as plants with a seed bank. Although it may be desirable to do this manually in some cases, the `Rcompadre` function `mpm_first_active` automates the task by returning an integer index for the first active stage class, as noted by the original study author. 

The `longevity` function also the argument `lx_crit`, which defines the critical threshold of survivorship that defines longevity. The default is 0.01, meaning that longevity is defined as the age at which only 1% of the synthetic cohort remain alive. Finally, the function requires us to set a maximum age to consider (`xmax`, which defaults to 1000).

Thus, our first steps in this analysis are to (i) extract the **U** matrices with `matU`, then (ii) extract the first stage with `mpm_first_active`. We add the outputs of these functions to our data using `mutate`.  

```{r first active and start life}
mammals <- mammals %>%
  mutate(
    matU = matU(.),
    start_life = mpm_first_active(.)
  )
```

Now we can apply the `longevity` function over our dataset using `mapply`. 

```{r, warning=FALSE}
mammals <- mammals %>%
  mutate(longevity = mapply(longevity, matU, start_life))
```

Now that we have the longevity data for all of our mammals we can actually explore its variation across the globe and across different orders of mammals.

First, we will look at how longevity varies spatially. Lets repeat our map from before but now incorporating longevity on the log scale as the colour of each point.

```{r long map plot, message = FALSE, warning=FALSE}
globalDist_longevity <- ggplot(mammals, aes(Lon, Lat)) +
  borders(database = "world", fill = "grey80", col = NA) +
  geom_point(aes(colour = log10(longevity)), alpha = 0.4) +
  scale_colour_viridis_c(option = "C") +
  labs(x = NULL, y = NULL) +
  theme_minimal()
```

```{r echo = FALSE}
library(patchwork)
(globalDist + ggtitle("A")) + (globalDist_longevity + ggtitle("B"))
ggsave("fig02_globalDistribution.png",width = 20,height = 8,units = "cm")
```


Although we see that longevity varies spatially, it isn't clear whether there are any spatial patterns. Lets look at whether longevity varies with either absolute latitude or across `Ecoregion` (we could naturally investigate associations with other variables in the metadata).

```{r long latitude, fig.width= 10, fig.height= 6, message = FALSE, warning=FALSE}
longevity_lat <- ggplot(mammals, aes(x = abs(Lat), y = log10(longevity))) +
  geom_point(alpha = 0.4) +
  labs(x = "Absolute Latitude", y = "log 10 (longevity)") +
  theme_minimal() +
  geom_smooth()

longevity_ecoregion <- ggplot(mammals, aes(
  x = Ecoregion, y = log10(longevity),
  fill = Ecoregion
)) +
  geom_violin(show.legend = FALSE) +
  labs(x = "Ecoregion", y = "log 10 (longevity)") +
  coord_flip() +
  theme_minimal()
```

```{r echo = FALSE}
library(patchwork)
(longevity_lat + ggtitle("A")) + (longevity_ecoregion + ggtitle("B"))
ggsave("fig03_longevityLatAndEcoregion.png", width = 20,height = 8,units = "cm")
```


There appears to be a decline in longevity at intermediate latitudes (Figure XA), and there is some variation among ecoregions (Figure XB). These patterns could well be driven by data biases, but would make an interesting topic for future exploration.

With the broad range of tools at our fingertips in `Rcompadre` and `Rage`, we can begin to address such detailed comparative questions with increased ease. 
